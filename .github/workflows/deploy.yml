name: Deploy and Test

on:
  push:
    branches:
      - master

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: 20

    - name: Install Dependencies
      run: |
        cd backend
        npm install
        cd ../frontend
        npm install
        cd ..

    - name: Run Tests
      run: |
        cd backend
        npm run test:cov
        cd ../frontend
        npm run test:cov
        cd ..

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ap-northeast-1

    - name: Sync files to S3
      run: |
        aws s3 sync reports/backend/coverage s3://${{ secrets.AWS_S3_BUCKET }}/bidding-platform/test-reports --delete

  package:
    runs-on: ubuntu-latest
    needs: build-and-test
    if: success()

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: 20 # 使用 Node.js 20

    - name: Install Dependencies
      run: npm install

    - name: Build Frontend
      working-directory: frontend
      run: |
        npm install
        npm run build --prod
      # outputs:
      #   frontend-dist: ${{ steps.build-frontend.outputs.frontend-dist }}

    - name: Build Backend
      working-directory: backend
      run: |
        npm install
        npm run build
      # outputs:
      #   backend-dist: ${{ steps.build-backend.outputs.backend-dist }}

  deploy:
    runs-on: ubuntu-latest
    needs: package
    if: success()

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Deploy to DigitalOcean
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.DROPLET_IP }}
        username: ${{ secrets.DROPLET_USER }}
        key: ${{ secrets.DROPLET_KEY }}
        script: |
          cd /var/www/bidding-platform
          git pull origin master || git clone https://github.com/dreaife/bidding-platform.git .
          
          # 构建前端
          cd frontend
          npm install
          npm run build --prod
          
          # 构建后端
          cd ../backend
          npm install
          npm run build
          
          # 创建 public 目录并移动前端文件
          mkdir -p public
          cp -r ../frontend/dist/frontend/browser/* public/
          
          # 启动后端服务
          pm2 restart all || pm2 start dist/main.js --name bidding-platform-backend
